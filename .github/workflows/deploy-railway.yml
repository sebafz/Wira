name: Deploy to Railway

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  BACKEND_PATH: './backend/Wira.Api'

jobs:
  # ================================
  # RAILWAY DEPLOYMENT
  # ================================
  deploy-railway:
    name: ğŸš„ Deploy to Railway
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.BACKEND_PATH }}
      
    - name: ğŸ—ï¸ Build
      run: dotnet build ${{ env.BACKEND_PATH }} --no-restore --configuration Release
      
    - name: ğŸ§ª Run Tests
      run: dotnet test ./backend/Wira.Api.Tests --no-build --configuration Release
      
    - name: ğŸš„ Deploy to Railway
      uses: bervProject/railway-deploy@v1.0.0
      with:
        railway_token: ${{ secrets.RAILWAY_TOKEN }}
        service: ${{ github.ref == 'refs/heads/main' && 'wira-api-prod' || 'wira-api-staging' }}
        
    - name: ğŸ“¢ Deployment Success
      run: |
        echo "ğŸš„ Deployed to Railway!"
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ğŸŒŸ Production URL: https://wira-api-prod.railway.app"
        else
          echo "ğŸ”§ Staging URL: https://wira-api-staging.railway.app"
        fi
